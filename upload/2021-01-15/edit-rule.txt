<template>
  <div class="edit-rule">
    <div class="white">
      <h3 class="emailSet">自定义解析规则</h3>
      <p class="smail-title">填写您忽略的组件及其漏洞，或者您认为不接受的许可证。解析后的结果将结合您配置的内容显示。</p>
      <div style="margin-top: 40px;">
        <el-card class="box-card">
          <div slot="header" class="clearfix">
            <span style="line-height: 40px;">规则列表</span>
            <el-button  type="primary" @click="handleAddBtn" style="float:right">添加规则</el-button>
            <el-popover
              placement="bottom"
              width="240"
              trigger="click"
              :value="showPopover">
              <el-form :model="popoverForm" ref="popoverForm" class="ignore-form" size="small">
                <el-form-item label="默认规则" prop="defaultRule">
                  <el-select v-model="popoverForm.defaultRule" placeholder="请选择默认规则">
                    <el-option
                      v-for="item in rulesArr"
                      :key="item.id"
                      :label="item.ruleName"
                      :value="item.id"
                    ></el-option>
                  </el-select>
                </el-form-item>
                <el-form-item style="margin-bottom: 5px;">
                  <el-button size="mini" type="success" class="miniBtn" @click="handleSureDefault" style="float: right;">确定</el-button>
                </el-form-item>
              </el-form>
              <el-button slot="reference" type="primary" @click="showPopover = true" style="float:right; margin-right: 20px;">默认规则</el-button>
            </el-popover>
          </div>
          <el-table
            :data="rulesArr"
            style="width: 100%">
            <el-table-column
              prop="ruleName"
              label="规则名称"
              width="120">
            </el-table-column>
            <el-table-column
              prop="vulLevel"
              label="默认规则"
              align="center"
              width="80">
              <template slot-scope="scope">
                <div v-if="scope.row.defaultRule">
                  <span class="el-icon-check lastsuccess"></span>
                </div>
              </template>
            </el-table-column>
            <el-table-column
              prop="vulLevel"
              label="CI/DI工具阻断等级"
              align="center"
              width="140">
              <template slot-scope="scope">
                <span>{{vulValueList[scope.row.vulLevel]}}</span>
              </template>
            </el-table-column>
            <el-table-column
              prop="indirectLicenseConflict"
              label="许可证兼容分析"
              align="center"
              width="130">
                <template slot-scope="scope">
                  <span v-if="scope.row.indirectLicenseConflict">所有依赖</span>
                  <span v-else>直接依赖</span>
                </template>
            </el-table-column>
            <el-table-column
              prop="dependencyDepth"
              label="解析层级"
              align="center"
              width="110">
                <template slot-scope="scope">
                  <span>{{depthValueList[scope.row.dependencyDepth]}}</span>
                </template>
            </el-table-column>
            <el-table-column
              prop="repoWhiteList"
              label="组件白名单"
              min-width="220">
              <template slot-scope="scope">
                <div class="content1" v-if="scope.row.repoWhiteList">
                  <el-tag
                    v-for="(tag,index) in scope.row.repoWhiteList.split(',')"
                    :key="index"
                    :disable-transitions="false"
                    v-show="tag != ''"
                  >{{tag}}</el-tag>
              </div>
              </template>
            </el-table-column>
            <el-table-column
              prop="blackLicenseList"
              label="许可证黑名单"
              min-width="220">
              <template slot-scope="scope">
                <div class="content" v-if="scope.row.blackLicenseList">
                  <el-tag
                    type="success"
                    v-for="(tag,index) in scope.row.blackLicenseList.split(',')"
                    :key="index"
                    :disable-transitions="false"
                    v-show="tag != ''"
                  >{{tag}}</el-tag>
              </div>
              </template>
            </el-table-column>
            <el-table-column
              label="操作"
              align="center"
              width="180">
              <template slot-scope="scope">
                <el-button
                  size="mini"
                  type="primary"
                  plain
                  @click="editRule(scope.row)">修改</el-button>
                <el-button
                  size="mini"
                  type="danger"
                  plain
                  @click="deleteRule(scope.row)">删除</el-button>
              </template>
            </el-table-column>
          </el-table>
        </el-card>
      </div>
    </div>
      <!-- 添加修改规则弹框 -->
      <el-dialog :title="dialogTitle" :visible.sync="dialogFormVisible" :close-on-click-modal='false'>
          <div @keyup.enter="handleAddConfirm" class="addRuleDialog">
            <p>规则名称：</p>
            <el-input v-model="form.name" 
              auto-complete="off" 
              placeholder="请输入规则名称"
              ></el-input>
            <p>解析层级：</p>
            <el-select v-model="form.depthValue" class="dialogLevelSelect" placeholder="请选择漏洞等级">
              <el-option label="只解析直接依赖" value='只解析直接依赖'></el-option>
              <el-option label="1层" value='1层'></el-option>
              <el-option label="2层" value='2层'></el-option>
              <el-option label="3层" value='3层'></el-option>
              <el-option label="4层" value='4层'></el-option>
              <el-option label="5层" value='5层'></el-option>
              <el-option label="6层" value='6层'></el-option>
              <el-option label="7层" value='7层'></el-option>
              <el-option label="8层" value='8层'></el-option>
            </el-select> 
            <p>CI/DI工具阻断等级：</p>
            <el-select v-model="vulValue" class="dialogLevelSelect" placeholder="请选择漏洞等级">
              <el-option
                v-for="item in vulList"
                :label="item.label"
                :value="item.label"
                :key="item.value"
              ></el-option>
            </el-select>
            <p>组件白名单：</p>
            <div v-for="(item, index) in form.repoWhiteList" :key="index" class="repoWhiteList">
              <el-input v-model="item.value" 
                auto-complete="off" 
                placeholder="示例：com.prism:backend-github"
              ></el-input>
               <el-button v-if="index === 0" type="primary" icon="el-icon-plus" plain size="mini" circle @click="addRepoWhiteList"></el-button>
               <el-button v-else type="danger" icon="el-icon-delete" plain size="mini" circle @click="deleteRepoWhiteList(index)"></el-button>
            </div>
            <p>许可证黑名单：</p>
            <el-autocomplete                  
              placeholder="请选择"
              v-model="whiteLicense"
              :fetch-suggestions="handleWhiteLicense"
              @select="handleSelect"
            ></el-autocomplete>
            <div class="licenseTag dialogTags">
              <el-tag
                v-for="(tag,index) in dynamicTags"
                :key="index"
                closable
                :disable-transitions="false"
                @close="handleLicenseColse(tag)"
                v-show="tag != ''"
              >{{tag}}</el-tag>
            </div>
            <p>许可证兼容分析：</p>
            <el-select v-model="form.indirectLicenseConflict" class="dialogLevelSelect" placeholder="请选择许可证兼容分析">
              <el-option label="直接依赖" :value="false"></el-option>
              <el-option label="所有依赖" :value="true"></el-option>
            </el-select>
          </div>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisible = false">取 消</el-button>
        <el-button type="primary"  
        @click="handleDialogConfirm" 
        >确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
import Cookies from "js-cookie";
import {
  getUserEmail,
  getBasicLicense,
  getParserRule,
  deleteSelfRule
} from "@/api/chartData";
import { posteditEmail, saveRule, addUserRule, postDefaultRule } from "@/api/updateApi";
export default {
  name: "rule",
  data() {
    return {
      email: "",
      user: "",
      emailmsg: "",
      whiteLicense: "", 
      whiteDepend: "",
      whiteDefect: "",
      libraryArr: [], 
      restaurants: [],
      dynamicTags: [],
      DependTags: [],
      DefectTags: [],
      ruleList: "",
      value: '',
      customRulesName: "", 
      rulesArr: [], 
      vulValue: '',
      vulList: [
        { label: "所有漏洞", value: "0" },
        { label: "严重漏洞", value: "4" },
        { label: "高危漏洞", value: "3" },
        { label: "中危漏洞", value: "2" },
        { label: "低危漏洞", value: "1" },
        { label: "无", value: "-1" }
      ],
      vulValueList: {
        1: "低危漏洞",
        2: "中危漏洞",
        3: "高危漏洞",
        4: "严重漏洞",
        0: "所有漏洞"
      },
      vulLabeList: {
        低危漏洞: 1,
        中危漏洞: 2,
        高危漏洞: 3,
        严重漏洞: 4,
        所有漏洞: 0
      },
      dialogFormVisible: false,
      dialogTitle: '',
      form: {
        name: '',
        repoWhiteList: [{value: ''}],
        depthValue: '',
        indirectLicenseConflict: false
      },
      showLevel: '',
      showrepoWhiteList: [],
      showBackLicense: '',
      isShowDetail: false,
      currRuleInfo: '',
      handleType: -1,
      popoverForm: {
        defaultRule: ''
      },
      showPopover: false,
      depthValueList: {
        0: "只解析直接依赖",
        1: "1层",
        2: "2层",
        3: "3层",
        4: "4层",
        5: "5层",
        6: "6层",
        7: "7层",
        8: "8层"
      },
      depthValueCode: {
        '只解析直接依赖': 0,
        '1层': 1,
        '2层': 2,
        '3层': 3,
        '4层': 4,
        '5层': 5,
        '6层': 6,
        '7层': 7,
        '8层': 8
      }
    };
  },
  methods: {
    // 自定义规则
    handleSureDefault() {
      let data = new URLSearchParams();
      data.append("userId", this.user.id);
      data.append("ruleId", this.popoverForm.defaultRule);
      postDefaultRule(data).then(resp => {
        this.showPopover = false
        this.getRule()
      })
    },
    addRepoWhiteList() {
      this.form.repoWhiteList.push({value: ''})
    },
    deleteRepoWhiteList(index) {
      this.form.repoWhiteList.splice(index, 1)
    },
    handleWhiteLicense(queryString, cb){
      const para = { key: this.whiteLicense };
      getBasicLicense(para).then(res => {
          this.libraryArr = res;
          this.restaurants = [];
          this.libraryArr.forEach((item, index) => {
              this.restaurants.push({ value: item });
          });
          cb(this.restaurants);
      });
    },
    // 依赖白名单
    handleWhiteDepend(queryString, cb){
      const para = { key: this.whiteLicense };
      getBasicLicense(para).then(res => {
        this.libraryArr = res;
        this.restaurants = [];
        this.libraryArr.forEach((item, index) => {
            this.restaurants.push({ value: item });
        });
        cb(this.restaurants);
      });
    },
    handleDependSelect(item){
      if (item.value) {
          this.DependTags.push(item.value);
      }
      this.whiteDepend = "";
    },
    handleSelect(item) {
      if (item.value) {
        this.dynamicTags.push(item.value);
      }
      this.whiteLicense = "";
    },
    // 获取用户自定义解析规则列表
    getRule() {
      this.loading = true
      const para = { userId: this.user.id };
      getParserRule(para).then(resp => {
        this.loading = false
        this.rulesArr = resp
      });
    },
    // 点击添加规则按钮
    handleAddBtn() {
      this.dialogFormVisible = true
      this.dialogTitle = '添加规则'
      this.handleType = 1
      this.form.name = ''
      this.form.depthValue = ''
      this.vulValue = ''
      this.dynamicTags = []
      this.form.repoWhiteList = [{value: ''}]
    },
    // 新增规则
    handleAddConfirm() {
      console.log(this.depthValueCode[this.form.depthValue])
      if(this.form.name == '') {
        this.$message({
          message: "请输入正确的规则名称！",
          type: "warning"
        });
      }else if(this.form.depthValue == '') {
        this.$message({
          message: "请选择解析层级！",
          type: "warning"
        });
      }else{
        let _repoWhiteList = []
        this.form.repoWhiteList.forEach(item => {
          _repoWhiteList.push(item.value)
        })
        let data = new URLSearchParams();
        data.append("ruleName", this.form.name);
        data.append("dependencyDepth", this.depthValueCode[this.form.depthValue]);
        data.append("userId", this.user.id);
        data.append("repoWhiteList", _repoWhiteList.join(','));
        data.append("blackLicenseList", this.dynamicTags.join(','));
        data.append("indirectLicenseConflict", this.form.indirectLicenseConflict)
        if((this.vulValue == '' ) || (this.vulValue == '无')) {
          data.append("vulLevel", -1);
        }else{
          data.append("vulLevel", this.vulLabeList[this.vulValue]);
        }
        addUserRule(data).then(resp => {
          if(resp > 0) {
            this.dialogFormVisible = false
            this.$message({
              message: "保存成功!",
              type: "success"
            });
            this.getRule();
            this.form.name = ''
            this.vulValue = ''
            this.dynamicTags = []
            this.form.repoWhiteList = [{value: ''}]
            this.handleType = -1
          }else{
            this.$message.error('添加失败!');
          }
        })
      }
    },
    //点击修改按钮
    editRule(currRuleInfo) {
      this.currRuleInfo = currRuleInfo
      this.value = this.currRuleInfo.ruleName 
      this.dialogFormVisible = true
      this.dialogTitle = '修改规则'
      this.handleType = 2
      this.form.name = this.value
      this.form.depthValue = this.depthValueList[currRuleInfo.dependencyDepth]
      if(this.currRuleInfo.vulLevel == -1) {
        this.vulValue == '无'
      }else{
        this.vulValue = this.vulValueList[this.currRuleInfo.vulLevel]
      }
      this.dynamicTags = this.currRuleInfo.blackLicenseList.split(',')
      this.form.repoWhiteList = []
      this.currRuleInfo.repoWhiteList.split(',').forEach(item => {
        this.form.repoWhiteList.push({value: item})
      })
    },
    //修改操作
    handleEditRule() {
      let _repoWhiteList = []
      this.form.repoWhiteList.forEach(item => {
        _repoWhiteList.push(item.value)
      })
      var data1 = new URLSearchParams();
      data1.append("id", this.currRuleInfo.id);
      data1.append("userId", this.user.id);
      data1.append("ruleName", this.form.name);
      data1.append("dependencyDepth", this.depthValueCode[this.form.depthValue]);
      data1.append("repoWhiteList", _repoWhiteList.join(','));
      data1.append("blackLicenseList", this.dynamicTags.join(','));
      data1.append("indirectLicenseConflict", this.form.indirectLicenseConflict)
      if((this.vulValue == '' ) || (this.vulValue == '无')) {
        data1.append("vulLevel", -1);
      }else{
        data1.append("vulLevel", this.vulLabeList[this.vulValue]);
      }
      addUserRule(data1).then(res => {
        this.dialogFormVisible = false
        if(res > 0) {
          this.$message({
            message: "修改成功!",
            type: "success"
          });
          this.getRule();
          this.form.name = ''
          this.vulValue = ''
          this.dynamicTags = []
          this.handleType = -1
        }else{
          this.$message.error("修改失败!");
        }
      })
    },
    // 添加或修改操作
    handleDialogConfirm() {
      if(this.handleType == 1) {
        this.handleAddConfirm()
      }else if(this.handleType == 2) {
        this.handleEditRule()
      }
    },
    // 删除规则
    deleteRule(row) {
      this.$confirm("确认删除该规则?", "提示", {
        confirmButtonText: "删除",
        cancelButtonText: "取消",
        type: "warning"
      }).then(() => {
        let id = row.id
        deleteSelfRule(id).then(resp => {
          this.$message({
            message: "删除成功!",
            type: "success"
          });
          this.getRule();
          this.value = ''
          this.isShowDetail = false
        })
      }).catch(() => {})
    },
    handleLicenseColse(tag) {
      this.dynamicTags.splice(this.dynamicTags.indexOf(tag), 1);
    },
    handleDependColse(tag) {
      this.DependTags.splice(this.DependTags.indexOf(tag), 1);
    },
    handleDefectColse(tag) {
      this.DefectTags.splice(this.DefectTags.indexOf(tag), 1);
    }
  },
  mounted() {
    // this.getEmail();
    this.getRule();
  },
  created() {
    this.user = JSON.parse(Cookies.get("user"));
  }
};
</script>
<style lang="scss" scoped>
  .edit-rule {
    /deep/ .el-card__header {
      padding: 10px 20px;
      background-color: #ccc;
    }
    /deep/ .dialogCon {
      /deep/ .el-input{
        width: 199px;
      }
    }
    .content1 {
      /deep/ .el-tag{
        color: #409eff;
      }
    }
  }
</style>
<style scoped>
.edit-rule {
  padding: 0 20px;
}



.email {
  margin-bottom: 30px;
}
.emailSet {
  border-bottom: 2px solid #ddd;
  padding-bottom: 10px;
  margin-bottom: 10px;
}
.email-input {
  width: 70%;
  padding-top: 10px;
}
.email-error {
  margin-bottom: 0px;
  color: red;
  font-size: 14px;
  height: 20px;
}
.smail-title {
  font-size: 14px;
  color: #666;
}
.licenseTag {
  margin-left: 42%;
}

.whiteLicense,
.whiteDepend,
.whiteDefect {
  padding-bottom: 20px;
  overflow: hidden;
}
.save {
  margin-top: 50px;
}
.white .el-select .el-input.is-focus .el-input__inner {
    border-color: #21BAA9;
}
</style>
<style lang="scss" scoped>
/deep/ .el-tag {
  margin: 5px;
}
/deep/ .el-autocomplete {
  margin-right: 20px;
  width: 100%;
}
.white{
    .LevelSelect{
        width: 50%;
    }
    /deep/ .el-input__inner:focus {
        border-color: #21BAA9;
    }
}
.ruleDetail{
    width: 90%;
    .ruleWrap {
        width: 100%;
        min-height: 50px;
        margin-top: 5px;
        .md-title{
            display: inline-block;
            font-size: 15px;
            margin-top: 0;
            color: #666;
            width: 130px;
        }
        .content{
            display: inline-block;
            // margin-left: 20px;
            font-size: 14px;
            // color: #409eff;
        }
    }
    /deep/ .el-row{
      margin-bottom: 15px;
    }
}
/deep/ .el-dialog__body {
    padding-top: 0;
}
.dialogTags{
    margin-left: 0;
}
.licenseTag{
    margin-left: 0;
}
.licenseTag1{
  margin-left: -5px;
  // .el-tag{
  //   color: #409eff;
  // }
}
.dialogLevelSelect {
    width: 100%;
}
/deep/ .el-select>.el-input {
  width: 100%;
}
.addRuleDialog{
  /deep/ .el-select {
    width: 70%;
  }
}
.repoWhiteList{
  margin-bottom: 10px;
  /deep/ .el-button.is-circle{
    padding: 7px;
    margin-left: 10px;
  }
}
.lastsuccess {
  color: #67c23a;
  font-size: 22px;
  font-weight: 700;
}
</style>
